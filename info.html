<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1000, user-scalable=yes">
<link rel="stylesheet" href="styles.css">
    <title>Punk Archives</title>
      <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
import { get, update, child } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";
import "./scripts/monthly-points.js";


    const firebaseConfig = {
      apiKey: "AIzaSyAoKv4PLrk4xvZF_IeUhfViwOLBYBv0czQ",
      authDomain: "punkarchivesdata.firebaseapp.com",
      projectId: "punkarchivesdata",
      storageBucket: "punkarchivesdata.firebasestorage.app",
      messagingSenderId: "272312472875",
      appId: "1:272312472875:web:048288b995db157dc8216e",
      measurementId: "G-24V1CEFHYP",
      databaseURL: "https://punkarchivesdata-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

const auth = getAuth(app);
auth.onAuthStateChanged((user) => {
  if (!user) {
    // User not logged in, redirect to login page or homepage
    window.location.href = '/login.html';
  }
});
window.loadLeaderboard = function () {
  console.log("loadLeaderboard function is running!"); // Debugging message

  const usersRef = ref(db, "users");

  get(usersRef)
    .then((snapshot) => {
      console.log("Database response received"); // Debugging message

      if (snapshot.exists()) {
        const users = snapshot.val();

        const sortedUsers = Object.entries(users)
          .map(([username, data]) => ({
            username: username,
            points: data.points || 0, // Default to 0 if missing
          }))
          .sort((a, b) => b.points - a.points) // Sort by points
          .slice(0, 3); // Get top 5

        const leaderboardDiv = document.getElementById("leaderboard");

        sortedUsers.forEach((user, index) => {
          const entry = document.createElement("p");
          entry.innerHTML = `<u><a href="user.html?user=${encodeURIComponent(user.username)}" style="color: #fff; text-decoration: none;">${user.username}: ${user.points}</a></u><br>`;
          leaderboardDiv.appendChild(entry);
        });
      } else {
        console.warn("No users found in the database."); // Debugging Log
        document.getElementById("leaderboard").innerText = "No leaderboard data available.";
      }
    })
    .catch((error) => {
      console.error("Error loading leaderboard:", error);
    });
};

// Function to display logged-in username
window.displayUsername = function () {
  onAuthStateChanged(auth, (user) => {
    if (user) {
      const email = user.email;
      const username = email.replace("@punkarchives.com", ""); // Extract username from email (lowercase)
      
      // Find the user in the database to get the proper capitalization
      const usersRef = ref(db, "users");
      get(usersRef).then((snapshot) => {
        if (snapshot.exists()) {
          const users = snapshot.val();
          // Find the user by matching the userId
          const userEntry = Object.entries(users).find(([key, data]) => data.userId === user.uid);
          if (userEntry) {
            const displayUsername = userEntry[0]; // This is the properly capitalized username
            document.getElementById("logged-in-user").innerHTML = `<u><a href="user.html?user=${encodeURIComponent(displayUsername)}" style="color: #fff; text-decoration: none;">${displayUsername}</a></u>`;
          } else {
            // Fallback to lowercase username if no match found
            document.getElementById("logged-in-user").innerHTML = `<u><a href="user.html?user=${encodeURIComponent(username)}" style="color: #fff; text-decoration: none;">${username}</a></u>`;
          }
        } else {
          // Fallback to lowercase username if no users found
          document.getElementById("logged-in-user").innerHTML = `<u><a href="user.html?user=${encodeURIComponent(username)}" style="color: #fff; text-decoration: none;">${username}</a></u>`;
        }
      }).catch((error) => {
        // Fallback to lowercase username on error
        document.getElementById("logged-in-user").innerHTML = `<u><a href="user.html?user=${encodeURIComponent(username)}" style="color: #fff; text-decoration: none;">${username}</a></u>`;
      });
    } else {
      document.getElementById("logged-in-user").innerText = "Not logged in.";
    }
  });
};

// Run function when page loads
window.onload = function () {
  console.log("Window loaded, running loadLeaderboard()"); // Debugging message
  loadLeaderboard();
  displayUsername();
};
    function slugify(name) {
      return name.trim().toLowerCase().replace(/[^a-z0-9]+/g, "_").replace(/^_+|_+$/g, "");
    }

    function getDefaultData(type, name) {
  if (type === "band") {
    return {
      band_name: name,
      description: "",
      genres: "",
      location: "",
      years_active: "",
      related_bands: "",
      members: [
        {
          name: "",
          instrument: ""
        }
      ],
      releases: [
        {
      title: "undefined",
      cover_image: "undefined",
      label: "undefined",
      year: "undefined",
      release_type: "undefined",
      physical_format: "undefined",
      limitation: "undefined",
      extra_info: "undefined",
      tracks: {
	0: "undefined"
      }
        }
      ]
    };
  } else if (type === "label") {
    return {
      label_name: name,
      location: "",
      years_active: "",
      description: "",
      bands: "",
      logo: "",
      compilations: []
    };
  } else if (type === "zine") {
    return {
      zine_name: name,
      authors: [],
      description: "",
      location: "",
      years_active: "",
      issues: []
    };
  }
  return {};
}


function addEntry(type) {
  const input = document.getElementById(`${type}-name`);
  const name = input.value.trim();
  if (!name) {
    alert("Please enter a name.");
    return;
  }

  // Check if it's a band and starts with "the "
  if (type === "band" && name.toLowerCase().startsWith("the ")) {
    alert("Band names cannot start with 'the '. Please format it like 'Hives, The' instead.");
    return;
  }

  const key = `${type}_${slugify(name)}`;
  const path = `${type}s/${key}`;
  const data = getDefaultData(type, name);

  set(ref(db, path), data)
    .then(() => {
      alert(`${type.charAt(0).toUpperCase() + type.slice(1)} added.`);
      input.value = "";

      // Update points for all types
      const user = auth.currentUser;
      if (user) {
        const lowercaseUsername = user.email.replace("@punkarchives.com", "").toLowerCase();
        
        // Find the proper capitalized username from database
        const usersRef = ref(db, "users");
        get(usersRef).then((usersSnapshot) => {
          let properUsername = lowercaseUsername; // fallback
          
          if (usersSnapshot.exists()) {
            const users = usersSnapshot.val();
            const userEntry = Object.entries(users).find(([key, data]) => data.userId === user.uid);
            if (userEntry) {
              properUsername = userEntry[0]; // This is the properly capitalized username
            }
          }
          
          const userRef = ref(db, `users/${properUsername}/points`);
          get(userRef).then((snapshot) => {
            let currentPoints = 0;
            if (snapshot.exists()) {
              currentPoints = snapshot.val();
            }

            set(userRef, currentPoints + 1);
            
            // Award monthly points based on type
            if (type === "band") {
              console.log('ðŸŽ¸ Attempting to award monthly band points...');
              console.log('window.monthlyPoints available:', !!window.monthlyPoints);
              if (window.monthlyPoints && window.monthlyPoints.awardMonthlyBandPoints) {
                console.log('âœ… Calling awardMonthlyBandPoints...');
                window.monthlyPoints.awardMonthlyBandPoints();
              } else {
                console.log('âŒ monthlyPoints or awardMonthlyBandPoints not available');
              }
            } else if (type === "label") {
              console.log('ðŸ·ï¸ Attempting to award monthly label points...');
              if (window.monthlyPoints && window.monthlyPoints.awardMonthlyLabelPoints) {
                console.log('âœ… Calling awardMonthlyLabelPoints...');
                window.monthlyPoints.awardMonthlyLabelPoints();
              } else {
                console.log('âŒ monthlyPoints or awardMonthlyLabelPoints not available');
              }
            } else if (type === "zine") {
              console.log('ðŸ“° Attempting to award monthly zine points...');
              if (window.monthlyPoints && window.monthlyPoints.awardMonthlyZinePoints) {
                console.log('âœ… Calling awardMonthlyZinePoints...');
                window.monthlyPoints.awardMonthlyZinePoints();
              } else {
                console.log('âŒ monthlyPoints or awardMonthlyZinePoints not available');
              }
            }
          }).catch((error) => {
            console.error("Error updating points:", error);
          });
        }).catch((error) => {
          console.error("Error finding user:", error);
        });
      }

      // Redirect to the page of the thing they just added
      setTimeout(() => {
        if (type === "band") {
          window.location.href = `band.html?band=${encodeURIComponent(name)}`;
        } else if (type === "label") {
          window.location.href = `label.html?label=${encodeURIComponent(name)}`;
        } else if (type === "zine") {
          window.location.href = `zine.html?zine=${encodeURIComponent(name)}`;
        }
      }, 1000); // Wait 1 second to show the alert

    })
    .catch(error => {
      console.error("Error adding entry:", error);
      alert("Failed to add entry.");
    });
}

    window.addEntry = addEntry;

window.login = function () {
  const originalUsername = document.getElementById("login-username").value;
  const password = document.getElementById("login-password").value;
  const username = originalUsername.toLowerCase(); // Normalize to lowercase for Firebase Auth

  if (!originalUsername || !password) {
    alert("Username and password are required!");
    return;
  }

  // Try to find the user by checking both lowercase and original capitalization
  const userRefLower = ref(db, "users/" + username);
  const userRefOriginal = ref(db, "users/" + originalUsername);
  
  // First try lowercase lookup
  get(userRefLower).then((snapshot) => {
    if (snapshot.exists()) {
      const fakeEmail = `${username}@punkarchives.com`;
      signInWithEmailAndPassword(auth, fakeEmail, password)
        .then((userCredential) => {
          alert("Login successful!");
        })
        .catch((error) => {
          alert("Login error: " + error.message);
        });
    } else {
      // If not found with lowercase, try original capitalization
      get(userRefOriginal).then((snapshot) => {
        if (snapshot.exists()) {
          const fakeEmail = `${username}@punkarchives.com`;
          signInWithEmailAndPassword(auth, fakeEmail, password)
            .then((userCredential) => {
              alert("Login successful!");
            })
            .catch((error) => {
              alert("Login error: " + error.message);
            });
        } else {
          alert("Username not found.");
        }
      });
    }
  });
};

window.logout = function () {
  signOut(auth)
    .then(() => {
      alert("You have logged out.");
    })
    .catch((error) => {
      console.error("Logout error:", error);
    });
};

window.signUp = function () {
  const originalUsername = document.getElementById("signup-username").value.trim();
  const password = document.getElementById("signup-password").value;
  const username = originalUsername.toLowerCase(); // Normalize to lowercase for storage

  if (!originalUsername || !password) {
    alert("Username and password are required!");
    return;
  }

  if (originalUsername.length > 15) {
    alert("Username cannot be longer than 15 characters!");
    return;
  }

  const fakeEmail = `${username}@punkarchives.com`;

  // Disable the signup button to prevent multiple submissions
  const signupButton = document.querySelector('button[onclick="signUp()"]');
  if (signupButton) {
    signupButton.disabled = true;
    signupButton.textContent = "Creating Account...";
  }

  // First, try to create the Firebase account
  createUserWithEmailAndPassword(auth, fakeEmail, password)
    .then((userCredential) => {
      // User created successfully, now create the user record in the database
      const userRef = ref(db, "users/" + originalUsername);
      const userData = {
        userId: userCredential.user.uid,
        points: 0,
        monthly_bands_points: 0,
        monthly_releases_points: 0,
        monthly_bands_date: 'Never',
        monthly_releases_date: 'Never'
      };
      
      return set(userRef, userData);
    })
    .then(() => {
      alert("Account created successfully!");
      // Clear the form
      document.getElementById("signup-username").value = "";
      document.getElementById("signup-password").value = "";
    })
    .catch((error) => {
      console.error("Signup error:", error);
      alert("Signup error: " + error.message);
    })
    .finally(() => {
      // Re-enable the signup button
      if (signupButton) {
        signupButton.disabled = false;
        signupButton.textContent = "Sign Up";
      }
    });
};

  </script>
</head>
<body>

    <div class="sidebar">
	 <a href="index.html#" style="text-decoration:none"><img src="assets/logo.png" width="140px"></a>
        <ul><font face="MyCustomFont">
            <li></li>
            <li><a href="bands.html#">All Bands</a></li>
            <li><a href="zines.html#">Zines</a></li>
            <li><a href="labels.html#">Labels</a></li>
            <li><a href="events.html#">Shows</a></li>
      <h1><font face="MyCustomFont" color="#aa0000">â”€â”€â”€â”€â”€â”€â”€â”€â”€</font></h1>
            <li><a href="users.html#">Users</a></li>
            <li><a href="https://discordapp.com/users/767006494595350578">Contact</a></li>
            <li><a href="info.html#">Add New</a></li>
      <h1><font face="MyCustomFont" color="#aa0000">â”€â”€â”€â”€â”€â”€â”€â”€â”€</font></h1>
        <ul>
            <li><a id="randomBandButton">Random Band</font></a></li>
        </ul>
    </div>
<script src="scripts/randomband.js" type="module"></script>
</font>
<div class="sidebar2">

<center>
<input type="text" id="signup-username" placeholder="Username" required><br>
<input type="password" id="signup-password" placeholder="Password" required><br>
<button onclick="signUp()">Sign Up</button><br><br>

<input type="text" id="login-username" placeholder="Username" required><br>
<input type="password" id="login-password" placeholder="Password" required><br>
<button onclick="login()">Log In</button><br>
<script src="scripts/additions.js"></script>

<br>
<center>
  <div class="latest-additions">
    <h2>Points</h2>
<div id="leaderboard"></div>
  </div>
</center>

<center><p><font size="3">Logged In As: </p><p class="log" id="logged-in-user">Not logged in.</font></p></center>

<button onclick="logout()">Log Out</button><br><br>
</div>


<div class="main-container">
    <div class="content">
      <h1>Add New Band / Label / Zine</h1>
      <div>
        <h2>Band <font color="#fff" size="2">put "the" at the end of band names (eg: Hives, The)</font></h2>
        <input type="text" id="band-name" placeholder="Band Name">
        <button onclick="addEntry('band')">Add Band</button>
      </div>
      <div>
        <h2>Label</h2>
        <input type="text" id="label-name" placeholder="Label Name">
        <button onclick="addEntry('label')">Add Label</button>
      </div>
      <div>
        <h2>Zine</h2>
        <input type="text" id="zine-name" placeholder="Zine Name">
        <button onclick="addEntry('zine')">Add Zine</button>
      </div>
    </div>
  </div>
  
  <script src="scripts/miniplayer.js"></script>
</body>
</html>
